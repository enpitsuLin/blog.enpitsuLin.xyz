---
title: cocos2d手游逆向——XXTEA加密
date: 2020-04-03 14:24:46
categories: [安卓]
tags: ["逆向","安卓"]
toc: true
description:
---
因为最近在玩一款挂机类的手机游戏，但是玩的挺难受，网上搜了几篇文章，起了点逆向的兴趣。

遂拿起半吊子的技术尝试照猫画虎。
<!--more-->
## 开始
先是将手机安装的APK文件导出，直接adb pull将/data/app里的APK文件拉取。

然后解压查看lib目录发现
!{% asset_img lib目录.jpg lib目录 %}
很明显这是一款基于cocos2dlua开发的手游，然后来到\assets\src目录下

!{% asset_img src目录.png src目录 %}
不过直接打开显示乱码，显然是经过加密的。
## 前期思考
网上搜索cocos2d加密，根据文件的内容结构，应该是以cocos2dlua默认的加密方法XXTEA算法进行加密的。

这种算法拥有相应的标识符和密钥，所以被加密的lua文件开头的一串`FF98392D`应该就是相应的标识
!{% asset_img sign标识.png sign标识 %}

接下来需要拿到密钥，直接拿起IDA对cocos2dlua.so进行调试。用IDA打开so等待自动分析完成，然后建立string list，直接搜索这个标识`FF98392D`
!{% asset_img 定位到密钥和标识.png 定位到密钥和标识 %}

可以看到一个奇怪的字符串witu_xxWEM，然后使用网上下载的XXTEADecrypt软件进行解码。

然后心满意足的打开.lua脚本，惊讶的发现还是不可读的乱码。
!{% asset_img 乱码.png 还是乱码 %}

不过这个文件的前几个字节还是一样的有标识`LJ` 所以我想是不是还是经过了一层XXTEA的加密。

于是我将`LJ`当做标识,IDA里继续搜索`LJ`获得Key，但是这次没有一个看似正确的结果。于是只能对汇编的代码进行分析。

## 半吊子汇编

在查阅cocos2dlua的资料后，我知道程序载入资源基本是通过luaLoadBuffer，许多直接hook函数解码的方法也是对该函数进行hook。

于是我就搜索luaLoadBuffer这个函数，与源码比对，发现似乎有点不一样。似乎是定义了自己的函数对密钥进行操作然后再调用官方的decrypt()

不过找了好久都没有头绪

## 豁然开朗

因为分析了半天还是没有得出有用的结论，开始在搜索引擎上瞎找。

然后在搜索LJ+cocos关键词发现，用UltraEdit打开前几个字节是LJ的话，说明这个文件是通过LuaJIT编译后的文件。

所以思路就不对(〃＞皿＜)

## 结局
网上对Luajit的相关资料都好老，下次再慢慢整。

然后完全第一次搞逆向玩，了解到IDA这个神奇的工具，心想大概还需要汇编方面的知识，有机会这次之后好好学习。